@using VHS.Services.Batches.DTO
@using VHS.Services.Common
@using VHS.Client.Services.Batches
@inject JobClientService JobClientService
@inject IDialogService Dialog
@inject ISnackbar Snackbar

<Dialog Title="Suggested Jobs" ShowDefaultActions="false">
  <ChildContent>
    @if (SuggestedJobs == null)
    {
      <MudProgressCircular Indeterminate="true" />
    }
    else if (!SuggestedJobs.Any())
    {
      <MudText>No suggestions available.</MudText>
    }
    else
        {
            <MudList T="JobDTO" Dense="true">
                @foreach (var s in SuggestedJobs)
                {
                    <MudListItem T="JobDTO" Value="s">
                        <div class="d-flex align-center justify-space-between" style="width:100%">
                            <div>
                                <strong>@s.Name</strong><br />
                                <small>
                                    Scheduled Date: @s.ScheduledDate.ToString("dd MMM yyyy") • Location: @(_locations[s.JobLocationTypeId])
                                </small>
                            </div>
                            <MudButton Size="Size.Small"
                                       Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       OnClick="() => ConfirmAdd(s)">
                                Add
                            </MudButton>
                        </div>
                    </MudListItem>
                }
            </MudList>
    }
  </ChildContent>
  <ActionsContent>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Default">Cancel</MudButton>
  </ActionsContent>
</Dialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }
  [Parameter] public List<JobDTO>? SuggestedJobs { get; set; }

  private readonly Dictionary<Guid, string> _locations = new()
  {
    [GlobalConstants.JOBLOCATION_SEEDER]       = "Seeding",
    // [GlobalConstants.JOBLOCATION_GERMINATING]   = "Germinating",
    // [GlobalConstants.JOBLOCATION_PROPAGATING]   = "Propagating",
    // [GlobalConstants.JOBLOCATION_GROWING]       = "Growing",
    [GlobalConstants.JOBLOCATION_HARVESTER]    = "Harvesting",
    // [GlobalConstants.JOBLOCATION_WASHING]       = "Washing",
    [GlobalConstants.JOBLOCATION_TRANSPLANTER] = "Transplanting",
    //[GlobalConstants.JOBLOCATION_TRANSPORT]     = "Transport",
  };

    private async Task ConfirmAdd(JobDTO job)
    {
        var parameters = new DialogParameters
        {
            { "ConfirmTitle", "Confirm Delete" },
            { "ConfirmMessage", $"Add '{job.Name}' as a planned job?" }
        };

        var options = new DialogOptions
            {
                CloseButton = true,
                CloseOnEscapeKey = false,
                MaxWidth = MaxWidth.Small,
                Position = DialogPosition.TopCenter
            };

        var dialog = await Dialog.ShowAsync<Confirm>("Confirm Add", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            job.Id = Guid.Empty;
            job.StatusId = GlobalConstants.JOBSTATUS_NOTSTARTED;
            await JobClientService.CreateJobAsync(job);
            Snackbar.Add($"'{job.Name}' added successfully.", Severity.Success);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}

@page "/jobs/list"
@using VHS.Client.Pages.Batches.Dialogs
@using VHS.Client.Pages.Batches.Calendars
@using VHS.Services.Batches.DTO
@using VHS.Client.Services.Batches
@using VHS.Services.Common

@inject IStringLocalizer<Shared> Localizer
@inject BatchClientService BatchClientService
@inject JobClientService JobClientService
@inject NavigationManager Nav
@inject IDialogService Dialog
@inject ISnackbar Snackbar
@inject UserPreferencesService UserPreferences
@inject PageTitleService PageTitleService
@inject LocalStorage LocalStorage

<MudStack Row="true" Class="mb-4">
    <MudSwitch @bind-Value="@ShowCalendarView" Label="@Localizer["CalendarView"]" Color="Color.Primary" />
</MudStack>

@if (ShowCalendarView)
{
    <CalendarView Jobs="JobList" />
}
else
{
    <MudExpansionPanels Class="mb-4">
        <MudExpansionPanel Text="@Localizer["Filters"]" Expanded="@_isFilterPanelExpanded">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="JobNameFilterText"
                                  T="string"
                                  Label="@Localizer["FilterByJobName"]"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Clearable="true"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  AdornmentColor="Color.Dark"
                                  Placeholder="@Localizer["EnterJobName"]" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="BatchNameFilterText"
                                  T="string"
                                  Label="@Localizer["FilterByBatchName"]"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Clearable="true"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  AdornmentColor="Color.Dark"
                                  Placeholder="@Localizer["EnterBatchName"]" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">                    
                    <MudDateRangePicker @ref="_jobDateRangePicker"
                                        Label="@Localizer["ScheduledDateRange"]"
                                        @bind-DateRange="SelectedScheduledDateRange"
                                        Variant="Variant.Outlined"
                                        DateFormat="@_userDateTimeFormat"
                                        Clearable="true"
                                        AutoClose="false">
                        <PickerActions>
                            <MudButton OnClick="@(() => _jobDateRangePicker?.CloseAsync(false))">@Localizer["Cancel"]</MudButton>
                            <MudButton Color="Color.Primary" OnClick="@(() => _jobDateRangePicker?.CloseAsync(true))">@Localizer["OK"]</MudButton>
                        </PickerActions>
                    </MudDateRangePicker>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudAutocomplete T="KeyValuePair<Guid, string>"
                                     @bind-Value="SelectedJobLocationForFilter"
                                     Label="@Localizer["FilterByLocation"]"
                                     Variant="Variant.Outlined"
                                     Dense="true"
                                     Clearable="true"
                                     SearchFunc="@SearchJobLocations"
                                     ToStringFunc="@(loc => loc.Equals(default(KeyValuePair<Guid, string>)) ? null : loc.Value)"
                                     AdornmentIcon="@Icons.Material.Filled.ArrowDropDown"
                                     AdornmentColor="Color.Dark"
                                     Placeholder="@Localizer["SelectLocation"]">
                        <ItemTemplate Context="loc">
                            <MudText>@loc.Value</MudText>
                        </ItemTemplate>
                    </MudAutocomplete>
                </MudItem>
                <MudItem xs="12" Class="d-flex justify-center align-center my-auto" Style="padding-top:0px;">
                    <MudCheckBox @bind-Value="CB_NotStarted" Label="@Localizer["NotStarted"]"></MudCheckBox>
                    <MudCheckBox @bind-Value="CB_InProgress" Label="@Localizer["InProgress"]"></MudCheckBox>
                    <MudCheckBox @bind-Value="CB_Completed" Label="@Localizer["Completed"]"></MudCheckBox>
                </MudItem>
                <MudItem xs="12">
                    <div class="d-flex justify-center mt-2" style="gap: 16px;">
                        <MudButton Variant="Variant.Filled"
                                   Size="Size.Large"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.FilterAlt"
                                   OnClick="ApplyFilter"
                                   Disabled="@IsLoading">
                            @Localizer["Filter"]
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Size="Size.Large"
                                   Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.Clear"
                                   OnClick="ClearFilter">
                            @Localizer["ClearFilters"]
                        </MudButton>
                    </div>
                </MudItem>
            </MudGrid>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <MudDataGrid T="JobDTO" Items="@JobList" Hover="true" Loading="@IsLoading" LoadingProgressColor="Color.Info" RowClick="@(args => EditJob(args.Item))" RowStyle="cursor: pointer;">
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="@Localizer["Name"]" Sortable="true" />
            <PropertyColumn Property="x => x.BatchName" Title="@Localizer["BatchName"]" Sortable="true" />
            <PropertyColumn Property="x => x.OrderOnDay" Title="@Localizer["RunOrder"]" Sortable="true" />
            <PropertyColumn Property="x => x.TrayCount" Title="@Localizer["Trays"]" Sortable="true" />
            <PropertyColumn Property="x => x.ScheduledDate" Title="@Localizer["ScheduledDate"]" Format="@_userDateTimeFormat" Sortable="true" />
            <TemplateColumn Title="@Localizer["Location"]">
                <CellTemplate Context="context">
                    <VHS.Client.Components.Status.JobLocationType StatusId="@context.Item.JobLocationTypeId" />
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="@Localizer["Status"]">
                <CellTemplate Context="context">
                    <VHS.Client.Components.Status.JobStatus StatusId="@context.Item.StatusId" />
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="@Localizer["Actions"]">
                <CellTemplate Context="context">
                    <MudStack Row Spacing="1">
                        <MudTooltip Text="@Localizer["Edit"]" Arrow="true" Placement="Placement.Top">
                            <MudIconButton Disabled="!context.Item.IsEditable" Icon="@Icons.Material.Outlined.Edit" Color="Color.Default" OnClick="@(() => EditJob(context.Item))" />
                        </MudTooltip>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager Items="@JobList" />
        </PagerContent>
    </MudDataGrid>
}

@if (!IsLoading && (JobList == null || !JobList.Any()))
{
    <MudAlert Severity="Severity.Info">@Localizer["NoJobsFound"]</MudAlert>
}

@code {
    private bool ShowCalendarView = false;
    private MudDateRangePicker? _jobDateRangePicker;
    private bool _isFilterPanelExpanded = true;

    private IEnumerable<JobDTO>? JobList;
    private List<JobDTO>? _suggestedJobs;
    private bool IsLoading = true;

    private bool CB_Completed = false;
    private bool CB_NotStarted = true;
    private bool CB_InProgress = true;
    private string? JobNameFilterText;
    private string? BatchNameFilterText;
    private KeyValuePair<Guid, string> SelectedJobLocationForFilter = default;
    private DateRange SelectedScheduledDateRange { get; set; } = new DateRange(null, null);

    private Dictionary<Guid, string> _locations;

    private string _userDateTimeFormat = "dd MMM yyyy";

    protected override async Task OnInitializedAsync()
    {
        _locations = new()
        {
            [GlobalConstants.JOBLOCATION_SEEDER] = Localizer["SeedingStation"],
            [GlobalConstants.JOBLOCATION_HARVESTER] = Localizer["HarvestingStation"],
            [GlobalConstants.JOBLOCATION_TRANSPLANTER] = Localizer["TransplantStation"],
        };
        PageTitleService.Title = "";
        PageTitleService.BackUrl = "";

        _userDateTimeFormat = await UserPreferences.GetDateTimeFormatAsync(dateOnly: true);

        await LoadFiltersFromStorage();
        await LoadJobs();
    }

    private async Task LoadFiltersFromStorage()
    {
        JobNameFilterText = await LocalStorage.GetStateAsync("VHS_FILTER_JOB_NAME");
        BatchNameFilterText = await LocalStorage.GetStateAsync("VHS_FILTER_JOB_BATCHNAME");

        CB_NotStarted = bool.TryParse(await LocalStorage.GetStateAsync("VHS_FILTER_JOB_CB_NOTSTARTED"), out var ns) ? ns : true;
        CB_InProgress = bool.TryParse(await LocalStorage.GetStateAsync("VHS_FILTER_JOB_CB_INPROGRESS"), out var ip) ? ip : true;
        CB_Completed = bool.TryParse(await LocalStorage.GetStateAsync("VHS_FILTER_JOB_CB_COMPLETED"), out var c) ? c : false;

        var startDateStr = await LocalStorage.GetStateAsync("VHS_FILTER_JOB_DATE_START");
        var endDateStr = await LocalStorage.GetStateAsync("VHS_FILTER_JOB_DATE_END");
        DateTime? startDate = DateTime.TryParse(startDateStr, out var sd) ? sd : null;
        DateTime? endDate = DateTime.TryParse(endDateStr, out var ed) ? ed : null;
        SelectedScheduledDateRange = new DateRange(startDate, endDate);

        var locKeyStr = await LocalStorage.GetStateAsync("VHS_FILTER_JOB_LOC_KEY");
        var locVal = await LocalStorage.GetStateAsync("VHS_FILTER_JOB_LOC_VAL");
        if (Guid.TryParse(locKeyStr, out var locKey) && locKey != Guid.Empty)
        {
            SelectedJobLocationForFilter = new KeyValuePair<Guid, string>(locKey, locVal);
        }
    }

    private async Task ApplyFilter()
    {
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_NAME", JobNameFilterText ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_BATCHNAME", BatchNameFilterText ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_CB_NOTSTARTED", CB_NotStarted.ToString());
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_CB_INPROGRESS", CB_InProgress.ToString());
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_CB_COMPLETED", CB_Completed.ToString());
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_DATE_START", SelectedScheduledDateRange.Start?.ToString("o") ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_DATE_END", SelectedScheduledDateRange.End?.ToString("o") ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_LOC_KEY", SelectedJobLocationForFilter.Key.ToString());
        await LocalStorage.SaveStateAsync("VHS_FILTER_JOB_LOC_VAL", SelectedJobLocationForFilter.Value ?? "");

        await LoadJobs();
    }

    private async Task ClearFilter()
    {
        JobNameFilterText = null;
        BatchNameFilterText = null;
        SelectedScheduledDateRange = new DateRange(null, null);
        SelectedJobLocationForFilter = default;
        CB_NotStarted = true;
        CB_InProgress = true;
        CB_Completed = false;

        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_NAME");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_BATCHNAME");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_CB_NOTSTARTED");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_CB_INPROGRESS");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_CB_COMPLETED");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_DATE_START");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_DATE_END");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_LOC_KEY");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_JOB_LOC_VAL");

        await LoadJobs();
    }

    private async Task LoadJobs()
    {
        IsLoading = true;
        StateHasChanged();

        var selectedStatusIds = new List<Guid>();
        if (CB_NotStarted) selectedStatusIds.Add(GlobalConstants.JOBSTATUS_NOTSTARTED);
        if (CB_InProgress) selectedStatusIds.Add(GlobalConstants.JOBSTATUS_INPROGRESS);
        if (CB_Completed) selectedStatusIds.Add(GlobalConstants.JOBSTATUS_COMPLETED);

        JobList = (await JobClientService.GetAllJobsAsync(
            name: JobNameFilterText,
            batchName: BatchNameFilterText,
            jobLocationTypeId: SelectedJobLocationForFilter.Key == Guid.Empty ? null : SelectedJobLocationForFilter.Key,
            scheduledDateFrom: SelectedScheduledDateRange.Start,
            scheduledDateTo: SelectedScheduledDateRange.End,
            statusIds: selectedStatusIds.Any() ? selectedStatusIds : null))
            .OrderBy(x => x.ScheduledDate).ThenBy(x => x.OrderOnDay)
            .ToList();

        IsLoading = false;
        StateHasChanged();
    }

    private Task<IEnumerable<KeyValuePair<Guid, string>>> SearchJobLocations(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult<IEnumerable<KeyValuePair<Guid, string>>>(_locations.OrderBy(loc => loc.Value).ToList());

        var result = _locations
            .Where(loc => loc.Value.Contains(value, StringComparison.InvariantCultureIgnoreCase))
            .OrderBy(loc => loc.Value)
            .ToList();

        return Task.FromResult<IEnumerable<KeyValuePair<Guid, string>>>(result);
    }

    private async Task ShowVirtualJobs()
    {
        _suggestedJobs = (await JobClientService.GetSuggestedJobsAsync())?.ToList() ?? new List<JobDTO>();
        var parameters = new DialogParameters { { "SuggestedJobs", _suggestedJobs } };
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            Position = DialogPosition.TopCenter
        };
        var dialog = await Dialog.ShowAsync<JobSuggestionsDialog>(Localizer["SuggestedJobs"], parameters, options);
        var result = await dialog.Result;
        await LoadJobs();
    }

    private async Task AddJob()
    {
        var newJob = new JobDTO
        {
            StatusId = GlobalConstants.JOBSTATUS_NOTSTARTED
        };

        var parameters = new DialogParameters
        {
            { "Job", newJob }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            Position = DialogPosition.TopCenter
        };

        var dialog = await Dialog.ShowAsync<JobDialog>(Localizer["AddNewJob"], parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var createdJob = (JobDTO)result.Data;
            await JobClientService.CreateJobAsync(createdJob);
            await LoadJobs();
            Snackbar.Add(Localizer["JobAddedSuccess"], Severity.Success);
        }
    }

    private async Task EditJob(JobDTO job)
    {
        if (job.IsEditable)
        {
            var parameters = new DialogParameters
        {
            { "Job", job }
        };

            var options = new DialogOptions
                {
                    CloseButton = true,
                    MaxWidth = MaxWidth.Medium,
                    FullWidth = true,
                    Position = DialogPosition.TopCenter
                };

            var dialog = await Dialog.ShowAsync<JobDialog>(Localizer["EditJob"], parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                var updatedJob = (JobDTO)result.Data;
                await JobClientService.UpdateJobAsync(updatedJob);
                await LoadJobs();
                Snackbar.Add(Localizer["JobUpdatedSuccess"], Severity.Success);
            }
        }
    }

    private async Task DeleteJob(JobDTO job)
    {
        if (job.IsDeletable)
        {


            var parameters = new DialogParameters
        {
            { "ConfirmTitle", Localizer["ConfirmDelete"].ToString() },
            { "ConfirmMessage", Localizer["ConfirmDeleteJobMessage"].ToString() }
        };

            var options = new DialogOptions
                {
                    CloseButton = true,
                    CloseOnEscapeKey = false,
                    MaxWidth = MaxWidth.Small,
                    Position = DialogPosition.TopCenter
                };

            var dialog = await Dialog.ShowAsync<Confirm>(Localizer["ConfirmDelete"].ToString(), parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                await JobClientService.DeleteJobAsync(job.Id);
                JobList = JobList?.Where(x => x.Id != job.Id).ToList();
                Snackbar.Add(Localizer["JobDeletedSuccess"], Severity.Success);
            }
        }
    }
}

@page "/batches/plans"
@using VHS.Client.Pages.Batches.Dialogs
@using VHS.Services.Batches.DTO
@using VHS.Services.Produce.DTO
@using VHS.Client.Services.Batches
@using VHS.Client.Services.Produce
@inject BatchPlanClientService BatchPlanClientService
@inject ProductClientService ProductClientService
@inject RecipeClientService RecipeClientService
@inject IDialogService Dialog
@inject ISnackbar Snackbar
@inject PageTitleService PageTitleService

<MudDataGrid Dense="true" T="BatchPlanDTO" Items="@PlansList" Hover="true" Loading="@IsLoading" LoadingProgressColor="Color.Info" RowClick="@(async args => await EditBatchPlan(args.Item))" RowStyle="cursor: pointer;">
    <ToolBarContent>
        <MudTooltip Text="Add New Plan" Arrow="true" Placement="Placement.Top">
            <MudButton Variant="Variant.Filled" Size="Size.Large" Color="Color.Primary" OnClick="@AddBatchPlan" EndIcon="@Icons.Material.Filled.Add">New Plan</MudButton>
        </MudTooltip>
        <MudSpacer />
        <MudTextField T="string"
                          Label="Filter by Name"
                          Variant="Variant.Outlined"
                          Clearable="true"
                          Value="BatchPlanNameFilterText"
                          ValueChanged="OnBatchPlanNameFilterTextChanged"
                          Immediate="true"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          AdornmentColor="Color.Dark"
                          Placeholder="Enter Plan Name" />
        <MudSpacer />
        <MudAutocomplete T="ProductDTO"
                         Label="Filter by Product"
                         Variant="Variant.Outlined"
                         Clearable="true"
                         SearchFunc="@SearchProducts"
                         ToStringFunc="@(p => p == null ? null : p.Name)"
                         Value="SelectedProduct"
                         ValueChanged="OnProductFilterChanged"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         AdornmentColor="Color.Dark"
                         Placeholder="Select a Product">
            <ItemTemplate Context="product">
                <MudText>@product.Name</MudText>
            </ItemTemplate>
        </MudAutocomplete>
        <MudSpacer />
        <MudAutocomplete T="RecipeDTO"
                         Label="Filter by Recipe"
                         Variant="Variant.Outlined"
                         Clearable="true"
                         SearchFunc="@SearchRecipes"
                         ToStringFunc="@(r => r == null ? null : r.Name)"
                         Value="SelectedRecipe"
                         ValueChanged="OnRecipeFilterChanged"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         AdornmentColor="Color.Dark"
                         Placeholder="Select a Recipe">
            <ItemTemplate Context="recipe">
                <MudText>@recipe.Name</MudText>
            </ItemTemplate>
        </MudAutocomplete>
        <MudSpacer />
        <MudStack Style="width:20%;">
            <MudDateRangePicker @ref="_dateRangePicker"
                                Label="Start Date Range"
                                @bind-DateRange="SelectedDateRange"
                                Variant="Variant.Outlined"
                                Clearable="true"
                                AutoClose="false">
                <PickerActions>
                    <MudButton OnClick="@(() => _dateRangePicker?.CloseAsync(false))">Cancel</MudButton>
                    <MudButton Color="Color.Primary" OnClick="OnDateRangeOkClicked">OK</MudButton>
                </PickerActions>
            </MudDateRangePicker>
        </MudStack>
        <MudSpacer />
        <MudCheckBox @bind-Value="CB_New" @bind-Value:after="LoadBatchPlans">New</MudCheckBox>
        <MudCheckBox @bind-Value="CB_Started" @bind-Value:after="LoadBatchPlans">Started</MudCheckBox>
        <MudCheckBox @bind-Value="CB_Finished" @bind-Value:after="LoadBatchPlans">Finished</MudCheckBox>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x.Name" Title="Name" Sortable="true" />
        <PropertyColumn Property="x => x.Recipe.Name" Title="Recipe" Sortable="true" />
        <PropertyColumn Property="x => x.StartDate" Title="Start" Format="dd MMM yyyy" Sortable="true" />
        <PropertyColumn Property="x => x.DaysForPlan" Title="Total days" Sortable="true" />
        <PropertyColumn Property="x => x.TraysPerDay" Title="Trays per day" Sortable="true" />
        <TemplateColumn Title="Total Trays" Sortable="true">
            <CellTemplate Context="context">
                @context.Item.TotalTrays
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Status" Sortable="true" SortBy="x => x.StatusId">
            <CellTemplate Context="context">
                <VHS.Client.Components.Status.BatchPlanStatus StatusId="@context.Item.StatusId" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn>
            <CellTemplate Context="context">
                @if (context.Item.StatusId == GlobalConstants.BATCHPLANSTATUS_NEW)
                {
                    <MudTooltip Text="Start Plan" Arrow="true" Placement="Placement.Top">
                        <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" OnClick="@(() => StartPlan(context.Item.Id))" />
                    </MudTooltip>
                }
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <CellTemplate Context="context">
                <MudStack Row Spacing="1">
                    <MudTooltip Text="Edit" Arrow="true" Placement="Placement.Top">
                        <MudIconButton Icon="@Icons.Material.Outlined.Edit" Color="Color.Default" OnClick="@(() => EditBatchPlan(context.Item))" Disabled="@(context.Item.StatusId == GlobalConstants.BATCHPLANSTATUS_FINISHED)" />
                    </MudTooltip>
                    <MudTooltip Text="Delete" Arrow="true" Placement="Placement.Top">
                        <MudIconButton Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(() => DeleteBatchPlan(context.Item.Id))" Disabled="@(context.Item.StatusId == GlobalConstants.BATCHPLANSTATUS_FINISHED)" />
                    </MudTooltip>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager Items="@PlansList" />
    </PagerContent>
</MudDataGrid>

@if (!IsLoading && (PlansList == null || !PlansList.Any()))
{
    <MudAlert Severity="Severity.Info">No plans found.</MudAlert>
}


@code {
    private MudDateRangePicker? _dateRangePicker;

    private IEnumerable<BatchPlanDTO>? PlansListFull;
    private IEnumerable<BatchPlanDTO>? PlansList;
    private bool IsLoading = true;
    private bool CB_Finished = false;
    private bool CB_New = true;
    private bool CB_Started = true;

    private string? BatchPlanNameFilterText;

    private IEnumerable<ProductDTO>? ProductsList;
    private ProductDTO? SelectedProduct;

    private IEnumerable<RecipeDTO>? RecipesList;
    private RecipeDTO? SelectedRecipe;

    private DateRange SelectedDateRange { get; set; } = new DateRange(null, null);

    protected override async Task OnInitializedAsync()
    {
        ProductsList = await ProductClientService.GetAllProductsAsync();
        RecipesList = await RecipeClientService.GetAllRecipesAsync();

        await LoadBatchPlans();

        PageTitleService.Title = "";
    }

    private async Task LoadBatchPlans()
    {
        IsLoading = true;

        var selectedStatusIds = new List<Guid>();
        if (CB_New) selectedStatusIds.Add(GlobalConstants.BATCHPLANSTATUS_NEW);
        if (CB_Started) selectedStatusIds.Add(GlobalConstants.BATCHPLANSTATUS_PLANNED);
        if (CB_Finished) selectedStatusIds.Add(GlobalConstants.BATCHPLANSTATUS_FINISHED);
        
        PlansListFull = (await BatchPlanClientService.GetAllBatchPlansAsync(
                            productId: SelectedProduct?.Id,
                            recipeId: SelectedRecipe?.Id,
                            name: BatchPlanNameFilterText,
                            startDateFrom: SelectedDateRange.Start,
                            startDateTo: SelectedDateRange.End,
                            statusIds: selectedStatusIds.Any() ? selectedStatusIds : null))
                        .OrderByDescending(x => x.StartDate)
                        .OrderByDescending(x => x.AddedDateTime);

        PlansList = PlansListFull; 
        IsLoading = false;
    }

    private async Task OnBatchPlanNameFilterTextChanged(string? value)
    {
        BatchPlanNameFilterText = value;
        await LoadBatchPlans();
    }

    private async Task<IEnumerable<ProductDTO>> SearchProducts(string value, CancellationToken token)
    {
        var filteredProducts = ProductsList?.Where(p => string.IsNullOrEmpty(value) || p.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase))
                                           .OrderBy(p => p.Name)
                                           .ToList();

        return filteredProducts ?? Enumerable.Empty<ProductDTO>();
    }

    private async Task<IEnumerable<RecipeDTO>> SearchRecipes(string value, CancellationToken token)
    {
        var filteredRecipes = RecipesList?.Where(r => string.IsNullOrEmpty(value) || r.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase))
                                         .OrderBy(r => r.Name)
                                         .ToList();

        return filteredRecipes ?? Enumerable.Empty<RecipeDTO>();
    }

    private async Task OnProductFilterChanged(ProductDTO? product)
    {
        SelectedProduct = product;
        await LoadBatchPlans();
    }

    private async Task OnRecipeFilterChanged(RecipeDTO? recipe)
    {
        SelectedRecipe = recipe;
        await LoadBatchPlans();
    }

    private async Task OnDateRangeOkClicked()
    {
        await _dateRangePicker!.CloseAsync(true);
        await LoadBatchPlans();
    }

    private async Task AddBatchPlan()
    {
        var parameters = new DialogParameters
        {
            { "BatchPlan", new BatchPlanDTO() }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true, Position = DialogPosition.TopCenter, BackdropClick=false };
        var dialog = await Dialog.ShowAsync<BatchPlanDialog>("New Plan", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var newPlan = (BatchPlanDTO)result.Data;
            var createdConfig = await BatchPlanClientService.CreateBatchPlanAsync(newPlan);
            await LoadBatchPlans();
            Snackbar.Add("Plan added successfully", Severity.Success);
        }
    }

    private async Task EditBatchPlan(BatchPlanDTO config)
    {
        var savedPlan = await BatchPlanClientService.GetBatchPlanByIdAsync(config.Id);
        if (savedPlan == null)
        {
            Snackbar.Add("Failed to load plan.", Severity.Error);
            return;
        }
        var parameters = new DialogParameters
        {
            { "BatchPlan", savedPlan }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true, Position = DialogPosition.TopCenter, BackdropClick = false };
        var dialog = await Dialog.ShowAsync<BatchPlanDialog>("Edit Plan", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var returnedPlan = (BatchPlanDTO)result.Data;

            if (returnedPlan.StatusId == GlobalConstants.BATCHPLANSTATUS_PLANNED)
            {
                Snackbar.Add("Plan started successfully.", Severity.Success);
            }
            else
            {
                await BatchPlanClientService.UpdateBatchPlanAsync(returnedPlan);
                Snackbar.Add("Plan updated successfully", Severity.Success);
            }

            await LoadBatchPlans();
        }
    }

    private async Task DeleteBatchPlan(Guid id)
    {
        var parameters = new DialogParameters
        {
            { "ConfirmTitle", "Confirm Delete" },
            { "ConfirmMessage", "Are you sure you want to delete this plan?" }
        };
        var options = new DialogOptions { CloseButton = true, CloseOnEscapeKey = false, MaxWidth = MaxWidth.Small, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<Confirm>("Confirm Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await BatchPlanClientService.DeleteBatchPlanAsync(id);
            await LoadBatchPlans();
            Snackbar.Add("Plan deleted successfully", Severity.Success);
        }
    }

    private async Task StartPlan(Guid id)
    {
        var parameters = new DialogParameters
        {
            { "ConfirmTitle", "Confirm Start" },
            { "ConfirmMessage", "Are you sure you want to start this plan? This action cannot be undone." }
        };
        var options = new DialogOptions
        {
            CloseButton = true,
            CloseOnEscapeKey = false,
            MaxWidth = MaxWidth.Small,
            Position = DialogPosition.TopCenter
        };

        var dialog = await Dialog.ShowAsync<Confirm>("Start Plan", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled)
            return;

        try
        {
            IsLoading = true;
            await BatchPlanClientService.StartBatchPlanAsync(id);

            await LoadBatchPlans();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to start plan: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }
}

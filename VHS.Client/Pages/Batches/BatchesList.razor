@page "/batches/list"
@using VHS.Client.Pages.Batches.Dialogs
@using VHS.Services.Batches.DTO
@using VHS.Services.Notes.DTO
@using VHS.Client.Services.Batches
@using VHS.Client.Services.Notes
@using VHS.Services.Common

@inject IStringLocalizer<Shared> Localizer
@inject PageTitleService PageTitleService
@inject BatchClientService BatchClientService
@inject NoteClientService NoteClientService
@inject IDialogService Dialog
@inject ISnackbar Snackbar
@inject UserPreferencesService UserPreferences
@inject LocalStorage LocalStorage

<MudExpansionPanels Class="mb-4">
    <MudExpansionPanel Text="@Localizer["Filters"]" Expanded="@_isFilterPanelExpanded">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="BatchNameFilterText"
                              T="string"
                              Label="@Localizer["FilterByBatchName"]"
                              Variant="Variant.Outlined"
                              Dense="true"
                              Clearable="true"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              AdornmentColor="Color.Dark"
                              Placeholder="@Localizer["EnterBatchName"]" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="PlanNameFilterText"
                              T="string"
                              Label="@Localizer["FilterByPlanName"]"
                              Variant="Variant.Outlined"
                              Dense="true"
                              Clearable="true"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              AdornmentColor="Color.Dark"
                              Placeholder="@Localizer["EnterPlanName"]" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudDateRangePicker @ref="_seedDateRangePicker"
                                    Label="@Localizer["SeedDateRange"]"
                                    @bind-DateRange="SelectedSeedDateRange"
                                    Variant="Variant.Outlined"
                                    DateFormat="@_userDateTimeFormat"
                                    Clearable="true"
                                    AutoClose="false">
                    <PickerActions>
                        <MudButton OnClick="@(() => _seedDateRangePicker?.CloseAsync(false))">@Localizer["Cancel"]</MudButton>
                        <MudButton Color="Color.Primary" OnClick="@(() => _seedDateRangePicker?.CloseAsync(true))">@Localizer["OK"]</MudButton>
                    </PickerActions>
                </MudDateRangePicker>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudDateRangePicker @ref="_harvestDateRangePicker"
                                    Label="@Localizer["HarvestDateRange"]"
                                    @bind-DateRange="SelectedHarvestDateRange"
                                    Variant="Variant.Outlined"
                                    DateFormat="@_userDateTimeFormat"
                                    Clearable="true"
                                    AutoClose="false">
                    <PickerActions>
                        <MudButton OnClick="@(() => _harvestDateRangePicker?.CloseAsync(false))">@Localizer["Cancel"]</MudButton>
                        <MudButton Color="Color.Primary" OnClick="@(() => _harvestDateRangePicker?.CloseAsync(true))">@Localizer["OK"]</MudButton>
                    </PickerActions>
                </MudDateRangePicker>
            </MudItem>
            <MudItem xs="12">
                <div class="d-flex justify-center mt-2" style="gap: 16px;">
                    <MudButton Variant="Variant.Filled"
                               Size="Size.Large"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.FilterAlt"
                               OnClick="ApplyFilter"
                               Disabled="@IsLoading">
                        @Localizer["Filter"]
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Size="Size.Large"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="ClearFilter">
                        @Localizer["ClearFilters"]
                    </MudButton>
                </div>
            </MudItem>
        </MudGrid>
    </MudExpansionPanel>
</MudExpansionPanels>

@if (BatchList != null)
{
    <MudDataGrid T="BatchDTO" Items="@BatchList.OrderBy(x=>x.SeedDate.Value)" Hover="true" Loading="@IsLoading" LoadingProgressColor="Color.Info" RowClick="@(async args => await EditBatch(args.Item))" RowStyle="cursor: pointer;">
    <Columns>
        <PropertyColumn Property="x => x.Name" Title="@Localizer["BatchName"]" Sortable="true" />
        <PropertyColumn Property="x => x.GrowPlan.Name" Title="@Localizer["Plan"]" Sortable="true" />
        <PropertyColumn Property="x => x.SeedDate.Value" Title="@Localizer["SeedDate"]" Format="@_userDateTimeFormat" Sortable="true" />
        <PropertyColumn Property="x => x.HarvestDate.Value" Title="@Localizer["HarvestDate"]" Format="@_userDateTimeFormat" Sortable="true" />
        <PropertyColumn Property="x => x.LotReference" Title="@Localizer["LotReference"]" Sortable="true" />
        <TemplateColumn Title="@Localizer["Notes"]">
            <CellTemplate Context="context">
                <MudTooltip Text="@Localizer["ViewNotes"]" Arrow="true" Placement="Placement.Top">
                    <MudIconButton Icon="@Icons.Material.Outlined.StickyNote2" Color="Color.Default" OnClick="@(() => ViewNotes(context.Item))" />
                </MudTooltip>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="@Localizer["Actions"]">
            <CellTemplate Context="context">
                <MudStack Row Spacing="1">
                    <MudTooltip Text="@Localizer["Edit"]" Arrow="true" Placement="Placement.Top">
                        <MudIconButton Icon="@Icons.Material.Outlined.Edit" Color="Color.Default" OnClick="@(() => EditBatch(context.Item))" />
                    </MudTooltip>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager Items="@BatchList" />
    </PagerContent>
</MudDataGrid>
}
@if (!IsLoading && (BatchList == null || !BatchList.Any()))
{
    <MudAlert Severity="Severity.Info">@Localizer["NoBatchesFound"]</MudAlert>
}

@code {
    private IEnumerable<BatchDTO> BatchList;
    private bool IsLoading = true;

    private bool _isFilterPanelExpanded = true;
    private MudDateRangePicker? _seedDateRangePicker;
    private MudDateRangePicker? _harvestDateRangePicker;
    private string BatchNameFilterText;
    private string PlanNameFilterText;
    private DateRange SelectedSeedDateRange = new DateRange(null, null);
    private DateRange SelectedHarvestDateRange = new DateRange(null, null);

    private string _userDateTimeFormat = "dd MMM yyyy";

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.Title = "";
        PageTitleService.BackUrl = "";

        _userDateTimeFormat = await UserPreferences.GetDateTimeFormatAsync(dateOnly: true);

        await LoadFiltersFromStorage();
        await LoadBatches();
    }

    private async Task LoadFiltersFromStorage()
    {
        BatchNameFilterText = await LocalStorage.GetStateAsync("VHS_FILTER_BATCH_BATCHNAME");
        PlanNameFilterText = await LocalStorage.GetStateAsync("VHS_FILTER_BATCH_PLANNAME");

        var seedStartStr = await LocalStorage.GetStateAsync("VHS_FILTER_BATCH_SEED_START");
        var seedEndStr = await LocalStorage.GetStateAsync("VHS_FILTER_BATCH_SEED_END");
        DateTime? seedStartDate = DateTime.TryParse(seedStartStr, out var sd) ? sd : null;
        DateTime? seedEndDate = DateTime.TryParse(seedEndStr, out var ed) ? ed : null;
        SelectedSeedDateRange = new DateRange(seedStartDate, seedEndDate);

        var harvestStartStr = await LocalStorage.GetStateAsync("VHS_FILTER_BATCH_HARVEST_START");
        var harvestEndStr = await LocalStorage.GetStateAsync("VHS_FILTER_BATCH_HARVEST_END");
        DateTime? harvestStartDate = DateTime.TryParse(harvestStartStr, out var hsd) ? hsd : null;
        DateTime? harvestEndDate = DateTime.TryParse(harvestEndStr, out var hed) ? hed : null;
        SelectedHarvestDateRange = new DateRange(harvestStartDate, harvestEndDate);
    }

    private async Task ApplyFilter()
    {
        await LocalStorage.SaveStateAsync("VHS_FILTER_BATCH_BATCHNAME", BatchNameFilterText ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_BATCH_PLANNAME", PlanNameFilterText ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_BATCH_SEED_START", SelectedSeedDateRange.Start?.ToString("o") ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_BATCH_SEED_END", SelectedSeedDateRange.End?.ToString("o") ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_BATCH_HARVEST_START", SelectedHarvestDateRange.Start?.ToString("o") ?? "");
        await LocalStorage.SaveStateAsync("VHS_FILTER_BATCH_HARVEST_END", SelectedHarvestDateRange.End?.ToString("o") ?? "");

        await LoadBatches();
    }

    private async Task ClearFilter()
    {
        BatchNameFilterText = null;
        PlanNameFilterText = null;
        SelectedSeedDateRange = new DateRange(null, null);
        SelectedHarvestDateRange = new DateRange(null, null);

        await LocalStorage.RemoveStateAsync("VHS_FILTER_BATCH_BATCHNAME");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_BATCH_PLANNAME");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_BATCH_SEED_START");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_BATCH_SEED_END");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_BATCH_HARVEST_START");
        await LocalStorage.RemoveStateAsync("VHS_FILTER_BATCH_HARVEST_END");

        await LoadBatches();
    }

    private async Task LoadBatches()
    {
        IsLoading = true;
        StateHasChanged();

        BatchList = await BatchClientService.GetAllBatchesAsync(
            batchName: BatchNameFilterText,
            planName: PlanNameFilterText,
            seedDateFrom: SelectedSeedDateRange.Start,
            seedDateTo: SelectedSeedDateRange.End,
            harvestDateFrom: SelectedHarvestDateRange.Start,
            harvestDateTo: SelectedHarvestDateRange.End
        );

		BatchList = BatchList.OrderBy(x=>x.SeedDate).ToList();

        if (BatchList != null)
        {
            foreach (var batch in BatchList)
            {
                batch.Notes = (await NoteClientService.GetNotesForEntityAsync(batch.Id))?.ToList() ?? new List<NoteDTO>();
            }
        }

        IsLoading = false;
        StateHasChanged();
    }

    private async Task AddBatch()
    {
        var parameters = new DialogParameters
        {
            { "Batch", new BatchDTO() }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<BatchDialog>("Add New Batch", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var newBatch = (BatchDTO)result.Data;
            newBatch.Jobs ??= new List<JobDTO>();
            if (newBatch.FarmId == Guid.Empty && newBatch.GrowPlan?.FarmId != Guid.Empty)
            {
                newBatch.FarmId = newBatch.GrowPlan.FarmId;
            }

            var createdBatch = await BatchClientService.CreateBatchAsync(newBatch);

            if (newBatch.Notes?.Any() == true)
            {
                foreach (var note in newBatch.Notes)
                {
                    note.EntityId = createdBatch.Id;
                    await NoteClientService.CreateNoteAsync(note);
                }
            }
            await LoadBatches();
            Snackbar.Add("Batch added successfully", Severity.Success);
        }
    }

    private async Task EditBatch(BatchDTO batch)
    {
        batch.Jobs ??= new List<JobDTO>();
        var parameters = new DialogParameters
        {
            { "Batch", batch }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<BatchDialog>("Edit Batch", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var updatedBatch = (BatchDTO)result.Data;
            updatedBatch.Jobs ??= new List<JobDTO>();
            if (updatedBatch.FarmId == Guid.Empty && updatedBatch.GrowPlan?.FarmId != Guid.Empty)
            {
                updatedBatch.FarmId = updatedBatch.GrowPlan.FarmId;
            }

            await BatchClientService.UpdateBatchAsync(updatedBatch);
            await LoadBatches();
            Snackbar.Add("Batch updated successfully", Severity.Success);
        }
    }

    private async Task ViewNotes(BatchDTO batch)
    {
        var parameters = new DialogParameters
        {
            { "Batch", batch }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<BatchDialog>("View/Edit Notes", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var updatedBatch = (BatchDTO)result.Data;
            await BatchClientService.UpdateBatchAsync(updatedBatch);
            await LoadBatches();
            Snackbar.Add("Notes updated successfully", Severity.Success);
        }
    }

    private async Task DeleteBatch(Guid id)
    {
        var parameters = new DialogParameters
        {
            { "ConfirmTitle", "Confirm Delete" },
            { "ConfirmMessage", "Are you sure you want to delete this batch?" }
        };
        var options = new DialogOptions { CloseButton = true, CloseOnEscapeKey = false, MaxWidth = MaxWidth.Small, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<Confirm>("Confirm Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await BatchClientService.DeleteBatchAsync(id);
            BatchList = BatchList.Where(x => x.Id != id).ToList();
            Snackbar.Add("Batch deleted successfully", Severity.Success);
        }
    }
}

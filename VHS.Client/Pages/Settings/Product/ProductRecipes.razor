@page "/system-settings/product/recipes"
@using VHS.Services.Produce.DTO
@using VHS.Client.Services.Produce
@using VHS.Client.Pages.Settings.Product

@inject IStringLocalizer<Shared> Localizer
@inject RecipeClientService RecipeClientService
@inject ProductClientService ProductClientService
@inject IDialogService Dialog
@inject ISnackbar Snackbar
@inject PageTitleService PageTitleService

<MudPaper Outlined="true" Square="true">
    <MudDataGrid T="RecipeDTO" Items="@FilteredRecipes" Hover="true" Loading="@IsLoading" LoadingProgressColor="Color.Info" RowClick="@(async args => await EditRecipe(args.Item))" RowStyle="cursor: pointer;">
        <ToolBarContent>
            <MudTooltip Text="@Localizer["AddNewRecipe"]" Arrow="true" Placement="Placement.Top">
                <MudButton Variant="Variant.Filled" Size="Size.Large" Color="Color.Primary" OnClick="@AddRecipe" EndIcon="@Icons.Material.Filled.Add">@Localizer["New"]</MudButton>
            </MudTooltip>
            <MudSelect T="Guid"
                       Label="@Localizer["FilterByProductVariant"]"
                       Value="_selectedProductId"
                       ValueChanged="OnProductVariantChanged"
                       Dense
                       Variant="Variant.Outlined"
                       Class="ml-2">
                <MudSelectItem Value="Guid.Empty">@Localizer["All"]</MudSelectItem>
                @foreach (var product in Products.OrderBy(p => p.Name))
                {
                    <MudSelectItem Value="@product.Id">
                        @product.Name
                    </MudSelectItem>
                }
            </MudSelect>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="@Localizer["Name"]" Sortable="true" InitialDirection="SortDirection.Ascending" />
            <PropertyColumn Property="x => x.Description" Title="@Localizer["Description"]" Sortable="true" />
            <PropertyColumn Property="x => x.Product.Name" Title="@Localizer["ProductVariant"]" Sortable="true" />
            <PropertyColumn Property="x => x.GrowDays" Title="@Localizer["GrowDays"]" Sortable="true" />
            <PropertyColumn Property="x => x.PropagationDays" Title="@Localizer["PropagationDays"]" Sortable="true" />
            <PropertyColumn Property="x => x.GerminationDays" Title="@Localizer["GerminationDays"]" Sortable="true" />
            <TemplateColumn Title="@Localizer["Actions"]">
                <CellTemplate Context="context">
                    <MudStack Row Spacing="1">
                        <MudTooltip Text="@Localizer["Edit"]" Arrow="true" Placement="Placement.Top">
                            <MudIconButton Icon="@Icons.Material.Outlined.Edit" Color="Color.Default" OnClick="@(() => EditRecipe(context.Item))" />
                        </MudTooltip>
                        <MudTooltip Text="@Localizer["Delete"]" Arrow="true" Placement="Placement.Top">
                            <MudIconButton Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(() => DeleteRecipe(context.Item.Id))" />
                        </MudTooltip>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager Items="@FilteredRecipes" />
        </PagerContent>
    </MudDataGrid>
    @if (FilteredRecipes == null || !FilteredRecipes.Any())
    {
        <MudAlert Severity="Severity.Info">@Localizer["NoRecipesFound"]</MudAlert>
    }
</MudPaper>

@code {
    private List<RecipeDTO> Recipes = new();
    private List<RecipeDTO> FilteredRecipes = new();
    private List<ProductDTO> Products = new();
    private bool IsLoading = true;
    private Guid _selectedProductId = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.BackText = $"<- {Localizer["SystemSettings"]}";
        PageTitleService.BackUrl = "/system-settings";
        PageTitleService.Title = Localizer["RecipesForProductVariants"];
        await LoadProducts();
        await LoadRecipes();
        ApplyFilter();
    }

    private async Task LoadRecipes()
    {
        IsLoading = true;
        Recipes = (await RecipeClientService.GetAllRecipesAsync())?.OrderBy(x=>x.Name).ToList() ?? new List<RecipeDTO>();
        IsLoading = false;
    }

    private async Task LoadProducts()
    {
        Products = (await ProductClientService.GetAllProductsAsync())?.OrderBy(x => x.Name).ToList() ?? new List<ProductDTO>();
    }

    private void OnProductVariantChanged(Guid selectedId)
    {
        _selectedProductId = selectedId;
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        if (_selectedProductId == Guid.Empty)
        {
            FilteredRecipes = Recipes;
        }
        else
        {
            FilteredRecipes = Recipes.Where(r => r.Product.Id == _selectedProductId).ToList();
        }
    }

    private async Task AddRecipe()
    {
        var parameters = new DialogParameters
        {
            { "Recipe", new RecipeDTO() }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<RecipeDialog>("Add New Recipe", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var newRecipe = (RecipeDTO)result.Data;
            var createdRecipe = await RecipeClientService.CreateRecipeAsync(newRecipe);
            Recipes.Add(createdRecipe);
            Recipes = Recipes.OrderBy(x => x.Name).ToList();
            ApplyFilter();
            Snackbar.Add("Recipe added successfully", Severity.Success);
        }
    }

    private async Task EditRecipe(RecipeDTO recipe)
    {
        var parameters = new DialogParameters
        {
            { "Recipe", recipe }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<RecipeDialog>("Edit Recipe", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var updatedRecipe = (RecipeDTO)result.Data;
            await RecipeClientService.UpdateRecipeAsync(updatedRecipe);
            var index = Recipes.FindIndex(r => r.Id == updatedRecipe.Id);
            if (index >= 0)
            {
                Recipes[index] = updatedRecipe;
            }
            Snackbar.Add("Recipe updated successfully", Severity.Success);
            await LoadRecipes();
            Recipes = Recipes.OrderBy(x => x.Name).ToList();
            ApplyFilter();
        }
    }

    private async Task DeleteRecipe(Guid id)
    {
        var parameters = new DialogParameters
        {
            { "ConfirmTitle", "Confirm Delete" },
            { "ConfirmMessage", "Are you sure you want to delete this recipe?" }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, Position = DialogPosition.TopCenter };
        var dialog = await Dialog.ShowAsync<Confirm>("Confirm Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await RecipeClientService.DeleteRecipeAsync(id);
            var recipeToRemove = Recipes.FirstOrDefault(r => r.Id == id);
            if (recipeToRemove != null)
            {
                Recipes.Remove(recipeToRemove);
            }
            ApplyFilter();
            Snackbar.Add("Recipe deleted successfully", Severity.Success);
        }
    }
}

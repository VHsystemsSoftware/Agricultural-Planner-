@using Microsoft.AspNetCore.Components.Forms
@using VHS.Services.Farming.DTO
@using VHS.Services.Produce.DTO
@using VHS.Client.Services.Farming
@using VHS.Client.Services.Produce
@inject FarmClientService FarmClientService
@inject ProductClientService ProductClientService
@inject ISnackbar Snackbar

<Dialog Title="@DialogTitle" ShowDefaultActions="false">
    <ChildContent>
        @if (!IsLoading)
        {
            <MudForm Model="Product" IsValid="IsValid">
                <MudSelect @bind-Value="Product.ProductCategoryId" Label="Product Variant" Variant="Variant.Outlined" Required="true">
                    @foreach (var category in ProductCategories)
                    {
                        <MudSelectItem Value="@category.Id">@category.Name</MudSelectItem>
                    }
                </MudSelect>
                <MudTextField @bind-Value="Product.Name" Label="Name" Variant="Variant.Outlined" Required="true" />
                <MudTextField @bind-Value="Product.Description" Lines="3" Label="Description" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="Product.SeedIdentifier" Label="Seed Identifier" Variant="Variant.Outlined" Required="true" />
                <MudTextField @bind-Value="Product.SeedSupplier" Label="Seed Supplier" Variant="Variant.Outlined" Required="true" />
                <MudField Label="Upload Image" Variant="Variant.Outlined" HelperText="Must be a PNG or JPG under 2048×2048 and 2MB.">
                    <MudStack Spacing="2">
                        <MudFileUpload T="IBrowserFile"
                                       Accept=".png, .jpg, .jpeg"
                                       FilesChanged="@(async file => await UploadFile(file))">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Outlined"
                                           Size="Size.Small"
                                           Color="Color.Default"
                                           StartIcon="@Icons.Material.Outlined.CloudUpload">
                                    Choose File
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>

                        @if (Product.HasImage)
                        {
                            <MudStack Direction="Row" Spacing="2" AlignItems="AlignItems.Center">
                                <MudImage Src="@Product.ImageData"
                                          Height="200"
                                          Alt="@($"Image for {Product.Name}")" />
                                <MudButton OnClick="ClearImage"
                                           Variant="Variant.Outlined"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           StartIcon="@Icons.Material.Outlined.Delete">
                                    Clear Image
                                </MudButton>
                            </MudStack>
                        }
                    </MudStack>
                </MudField>


            </MudForm>
        }
    </ChildContent>
    <ActionsContent>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="Save" Disabled="!IsValid" Variant="Variant.Filled" Color="Color.Primary">Save</MudButton>
    </ActionsContent>
</Dialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }
    [Parameter] public ProductDTO Product { get; set; } = new ProductDTO();
    [Parameter] public List<ProductCategoryDTO> ProductCategories { get; set; } = new();

    private MudForm form = new MudForm();
    private List<FarmDTO> Farms = new List<FarmDTO>();
    private bool IsLoading { get; set; } = true;
    private Guid SelectedFarmId { get; set; }

    private string DialogTitle => Product.Id == Guid.Empty ? "Add Product Variant" : "Edit Product Variant";

    private bool IsValid =>
        Product.ProductCategoryId != Guid.Empty &&
        !string.IsNullOrWhiteSpace(Product.Name) &&
        !string.IsNullOrWhiteSpace(Product.SeedIdentifier) &&
        !string.IsNullOrWhiteSpace(Product.SeedSupplier) &&
        SelectedFarmId != Guid.Empty &&
        (!Product.HasImage || ImageIsValid);

    private bool ImageIsValid = true;

    protected override async Task OnInitializedAsync()
    {
        Farms = (await FarmClientService.GetAllFarmsSimpleAsync())?.ToList() ?? new List<FarmDTO>();

        if (Product.ProductCategoryId == Guid.Empty && ProductCategories.Any())
        {
            Product.ProductCategoryId = ProductCategories.First().Id;
        }

        if (Product.FarmId != Guid.Empty)
        {
            SelectedFarmId = Product.FarmId;
        }
        else if (Farms.Any())
        {
            SelectedFarmId = Farms.First().Id;
        }

        if (Product.HasImage && string.IsNullOrWhiteSpace(Product.ImageData))
        {
            var imageUrl = ProductClientService.GetProductImageUrl(Product.Id);
            using var httpClient = new HttpClient();
            var imageBytes = await httpClient.GetByteArrayAsync(imageUrl);
            var base64 = Convert.ToBase64String(imageBytes);
            var mimeType = "image/png";
            Product.ImageData = $"data:{mimeType};base64,{base64}";
        }

        IsLoading = false;
    }

    private async Task UploadFile(IBrowserFile file)
    {
        if (file != null)
        {
            try
            {
                var result = await ProductClientService.ValidateAndUploadImageAsync(file);
                if (result != null)
                {
                    Product.ImageData = result.ImageData;
                    Product.HasImage = result.HasImage;
                    ImageIsValid = true;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Product.ImageData = null;
                Product.HasImage = false;
                ImageIsValid = false;
                Snackbar.Add($"Image upload failed: {ex.Message}", Severity.Warning);
            }
        }
    }

    private void ClearImage()
    {
        Product.ImageData = null;
        Product.HasImage = false;
    }

    private void Save()
    {
        if (form.IsValid)
        {
            Product.FarmId = SelectedFarmId;
            MudDialog.Close(DialogResult.Ok(Product));
        }
    }

    private void Cancel() => MudDialog.Cancel();
}

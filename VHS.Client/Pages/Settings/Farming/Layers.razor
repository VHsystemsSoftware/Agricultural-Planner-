@page "/system-settings/farm/layers"
@using VHS.Services.Farming.DTO
@using VHS.Client.Services.Farming
@using VHS.Services.Common.DataGrid
@using VHS.Services.Common.DataGrid.Enums

@inject IStringLocalizer<Shared> Localizer
@inject LayerClientService LayerClientService
@inject RackClientService RackClientService
@inject ISnackbar Snackbar
@inject IDialogService Dialog
@inject PageTitleService PageTitleService
@inject FarmClientService FarmClientService

<MudPaper Outlined="true" Square="true">
    <MudDataGrid @ref="dataGrid" T="LayerDTO" ServerData="LoadLayerData" CurrentPage="0" RowsPerPage="100">
        <ToolBarContent>
            <MudText Typo="Typo.h5" Color="Color.Default">@Localizer["Layers"]</MudText>
            <MudSpacer />
            @if (!IsLoading && RackList.Any())
            {
                <MudSelect T="Guid" Label="@Localizer["SelectRack"]" Variant="Variant.Outlined" Value="@SelectedRackId" ValueChanged="OnRackChanged">
                    @foreach (var rack in RackList.OrderBy(x => x.Floor.Number).ThenBy(x => x.Number))
                    {
                        <MudSelectItem Value="@rack.Id">
                            <strong>@Localizer["Floor"]:</strong> @rack.Floor.Name <strong>@Localizer["Rack"]: </strong> @rack.Name (@rack.LayerCount)
                        </MudSelectItem>
                    }
                </MudSelect>
            }
        </ToolBarContent>
        <Columns>
            @if (!IsLoading && RackList.Any())
            {
                <PropertyColumn Property="x => x.Number" Title="@Localizer["LayerNumber"]" Sortable="true" />
                <TemplateColumn Title="@Localizer["Enabled"]" Sortable="true">
                    <CellTemplate Context="context">
                        <MudSwitch T="bool" Label="@(context.Item.Enabled? Localizer["Yes"] : Localizer["No"])"
                                   Value="context.Item.Enabled"
                                   ValueChanged="@(async (bool newValue) => await OnToggleEnabled(context.Item, newValue))"
                                   Color="Color.Success" />
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="@Localizer["IsBufferLayer"]" Sortable="true">
                    <CellTemplate Context="context">
                        <MudSwitch T="bool" Label="@(context.Item.IsBufferLayer? Localizer["Yes"] : Localizer["No"])"
                                   Value="context.Item.IsBufferLayer"
                                   ValueChanged="@(async (bool newValue) => await OnToggleBufferLayer(context.Item, newValue))"
                                   Color="Color.Success" />
                    </CellTemplate>
                </TemplateColumn>

            }
        </Columns>
    </MudDataGrid>

    @if (!LayerList.Any())
    {
        <MudAlert Severity="Severity.Info">@Localizer["NoLayersFound"]</MudAlert>
    }
</MudPaper>

@code {
    private MudDataGrid<LayerDTO> dataGrid = new();
    private Guid SelectedRackId { get; set; } = Guid.Empty;
    private List<RackDTO> RackList = new();
    private List<LayerDTO> LayerList = new();
    private int TotalLayerCount;
    private bool IsLoading;

    private RackDTO? SelectedRack => RackList.FirstOrDefault(r => r.Id == SelectedRackId);

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.BackText = $"<- {Localizer["SystemSettings"]}";
        PageTitleService.BackUrl = "/system-settings";
        PageTitleService.Title = Localizer["Layers"];

        var _selectedFarm = await FarmClientService.GetFirstFarmsSimpleAsync();

        await LoadRacks(_selectedFarm.Id);
        if (RackList.Any())
        {
            SelectedRackId = RackList.First().Id;
            await dataGrid.ReloadServerData();
        }
    }

    private async Task LoadRacks(Guid farmId)
    {
        var racks = await RackClientService.GetAllRacksAsync(farmId);
        if (racks != null)
        {
            RackList = racks.ToList();
        }
    }

    private async Task<GridData<LayerDTO>> LoadLayerData(GridState<LayerDTO> state)
    {
        if (SelectedRackId == Guid.Empty)
        {
            return new GridData<LayerDTO> { Items = new List<LayerDTO>(), TotalItems = 0 };
        }

        IsLoading = true;

        var sortColumn = state.SortDefinitions.FirstOrDefault();
        var sortLabel = sortColumn?.SortBy ?? nameof(LayerDTO.Number);
        var sortDirection = (sortColumn?.Descending ?? false)
            ? SortDirectionEnum.Descending
            : SortDirectionEnum.Ascending;

        var response = await LayerClientService.GetLayersByRackAsync(
            SelectedRackId,
            state.Page,
            state.PageSize,
            sortLabel,
            sortDirection
        );

        IsLoading = false;
        LayerList = response?.Items?.ToList() ?? new List<LayerDTO>();
        TotalLayerCount = response?.TotalCount ?? 0;

        return new GridData<LayerDTO>
        {
            Items = LayerList,
            TotalItems = TotalLayerCount
        };
    }

    private async Task OnRackChanged(Guid newRackId)
    {
        SelectedRackId = newRackId;
        await dataGrid.ReloadServerData();
    }

    private async Task OnToggleEnabled(LayerDTO layer, bool newValue)
    {
        var dto = new EnabledDTO
        {
            Id = layer.Id,
            Enabled = newValue
        };

        await LayerClientService.EnableLayerAsync(dto);

        layer.Enabled = newValue;
        Snackbar.Add(Localizer["LayerUpdatedSuccess"], Severity.Success);
        StateHasChanged();
    }

    private async Task OnToggleBufferLayer(LayerDTO layer, bool newValue)
    {
        var dto = new EnabledDTO
        {
            Id = layer.Id,
            Enabled = newValue
        };

        await LayerClientService.BufferLayerLayerAsync(dto);

        await dataGrid.ReloadServerData();

        Snackbar.Add(Localizer["LayerUpdatedSuccess"], Severity.Success);
        StateHasChanged();

    }
}

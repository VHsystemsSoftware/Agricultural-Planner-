@page "/system-settings/farm/floors"
@using VHS.Services.Farming
@using VHS.Services.Farming.DTO
@using VHS.Client.Services.Farming
@using VHS.Client.Pages.Settings.Farming

@inject IStringLocalizer<Shared> Localizer
@inject ISnackbar Snackbar
@inject IDialogService Dialog
@inject FloorClientService FloorsClientService
@inject PageTitleService PageTitleService

<MudPaper Outlined="true" Square="true">
    <MudDataGrid Items="@FloorList" Hover="true" Loading="@IsLoading" LoadingProgressColor="Color.Info">
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="@Localizer["Name"]" Sortable="true" />
            <PropertyColumn Property="x => x.Number" Title="@Localizer["FloorNumber"]" Sortable="true" />
            <TemplateColumn Title="@Localizer["Enabled"]" Sortable="true">
                <CellTemplate Context="context">
                    <MudSwitch T="bool" Label="@(context.Item.Enabled? Localizer["Yes"] : Localizer["No"])"
                        Value="context.Item.Enabled"
                        ValueChanged="@(async (bool newValue) => await OnToggleEnabled(context.Item, newValue))"
                        Color="Color.Success" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
    @if (FloorList == null || !FloorList.Any())
    {
        <MudAlert Severity="Severity.Info">@Localizer["NoFloorsFound"]</MudAlert>
    }
</MudPaper>

@code {
    private IEnumerable<FloorDTO>? FloorList;
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.BackText = $"<- {Localizer["SystemSettings"]}";
        PageTitleService.BackUrl = "/system-settings";
        PageTitleService.Title = Localizer["Floors"];

        await LoadFloors();
    }

    private async Task LoadFloors()
    {
        IsLoading = true;
        FloorList = await FloorsClientService.GetAllFloorsAsync();
        IsLoading = false;
    }

    private async Task OnToggleEnabled(FloorDTO floor, bool newValue)
    {
        // var parameters = new DialogParameters
        //     {
        //         { "ConfirmTitle", "Confirm Change" },
        //         { "ConfirmMessage", $"Are you sure you want to {(newValue ? "enable" : "disable")} this floor?" }
        //     };

        // var options = new DialogOptions
        //     {
        //         CloseButton = true,
        //         CloseOnEscapeKey = false,
        //         MaxWidth = MaxWidth.Small,
        //         Position = DialogPosition.TopCenter
        //     };

        // var dialog = await Dialog.ShowAsync<Confirm>("Confirm", parameters, options);
        // var result = await dialog.Result;

        // if (!result.Canceled)
        // {
        //     try
        //     {
                var dto = new EnabledDTO
                    {
                        Id = floor.Id,
                        Enabled = newValue
                    };

                await FloorsClientService.EnableFloorAsync(dto);

                floor.Enabled = newValue;
                Snackbar.Add(Localizer["FloorUpdatedSuccess"], Severity.Success);
                StateHasChanged();
        //     }
        //     catch (Exception ex)
        //     {
        //         Snackbar.Add("Failed to update floor: " + ex.Message, Severity.Error);
        //     }
        // }
    }
}

@page "/user/settings"
@attribute [Authorize]

@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json
@using VHS.Services.Auth.DTO
@using VHS.Client.Services.Auth
@using VHS.Client.Common
@using VHS.Client.Pages.User
@using VHS.Services.Common.Enums.Languages
@using VHS.Services.Common.Enums.Themes
@using VHS.Services.Common.Enums.Measurements
@using VHS.Services.Common.Enums.DateTimeFormats
@using MetricUnits = VHS.Services.Common.Enums.Measurements.Metric
@using ImperialUnits = VHS.Services.Common.Enums.Measurements.Imperial
@using Blazored.LocalStorage

@inject UserSettingClientService UserSettingClientService
@inject ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject PageTitleService PageTitleService
@inject IStringLocalizer<Shared> Localizer
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <EditForm Model="@_viewModel" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <MudCard>
            <MudCardContent>
                <MudGrid Spacing="4">

                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.h6" GutterBottom="true">@Localizer["Profile"]</MudText>
                        <MudText Typo="Typo.body2" Class="mb-6">@Localizer["ProfileSubtitle"]</MudText>

                        <MudTextField @bind-Value="_viewModel.FirstName"
                                        Label="@Localizer["FirstName"]"
                                        For="@(() => _viewModel.FirstName)"
                                        Variant="Variant.Outlined"
                                        Required="true" />

                        <MudTextField @bind-Value="_viewModel.LastName"
                                        Label="@Localizer["LastName"]"
                                        For="@(() => _viewModel.LastName)"
                                        Class="mt-3"
                                        Variant="Variant.Outlined"
                                        Required="true" />

                        <MudTextField @bind-Value="_viewModel.Email"
                                        Label="@Localizer["Email"]"
                                        For="@(() => _viewModel.Email)"
                                        Class="mt-3"
                                        Variant="Variant.Outlined"
                                        Required="true"
                                        InputType="InputType.Email" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.h6" GutterBottom="true">@Localizer["Preferences"]</MudText>
                        <MudText Typo="Typo.body2" Class="mb-4">@Localizer["PreferencesSubtitle"]</MudText>

                        <MudSelect T="string" Label="@Localizer["Language"]" @bind-Value="_viewModel.PreferredLanguage" Variant="Variant.Outlined" Required="true">
                            @foreach (var item in _languageMapping)
                            {
                                <MudSelectItem Value="@item.Value">@item.Key</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="@Localizer["Theme"]" @bind-Value="_viewModel.PreferredTheme" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var theme in Enum.GetNames(typeof(ThemeEnum)))
                            {
                                <MudSelectItem Value="@theme">@theme</MudSelectItem>
                            }
                        </MudSelect>

                        
                        <MudSelect T="string" Label="Date/Time Format" @bind-Value="_viewModel.PreferredDateTimeFormat" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var format in _dateTimeFormatMapping)
                            {
                                <MudSelectItem Value="@format.Key">@($"{format.Key} ({format.Value})")</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="@Localizer["MeasurementSystem"]" Value="@_viewModel.PreferredMeasurementSystem" Class="mt-3" Variant="Variant.Outlined" Required="true" ValueChanged="OnMeasurementSystemChanged">
                            @foreach (var ms in Enum.GetNames(typeof(MeasurementSystemEnum)))
                            {
                                <MudSelectItem Value="@ms">@ms</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="@Localizer["WeightUnit"]" @bind-Value="_viewModel.PreferredWeightUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var wu in _weightUnitOptions)
                            {
                                <MudSelectItem Value="@wu">@wu</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="@Localizer["LengthUnit"]" @bind-Value="_viewModel.PreferredLengthUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var lu in _lengthUnitOptions)
                            {
                                <MudSelectItem Value="@lu">@lu</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="@Localizer["TemperatureUnit"]" @bind-Value="_viewModel.PreferredTemperatureUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var tu in _temperatureUnitOptions)
                            {
                                <MudSelectItem Value="@tu">@tu</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="@Localizer["VolumeUnit"]" @bind-Value="_viewModel.PreferredVolumeUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var vu in _volumeUnitOptions)
                            {
                                <MudSelectItem Value="@vu">@vu</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
            <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">@Localizer["SaveSettings"]</MudButton>
            </MudCardActions>
        </MudCard>
    </EditForm>
</MudContainer>

@code {
    private UserSettingDTO _viewModel = new();
    private Dictionary<string, string> _languageMapping = new() { { "English", "en-US" }, { "Dutch", "nl-NL" } };
    private Dictionary<string, string> _dateTimeFormatMapping = new();
    private IEnumerable<string> _weightUnitOptions = Enumerable.Empty<string>();
    private IEnumerable<string> _lengthUnitOptions = Enumerable.Empty<string>();
    private IEnumerable<string> _temperatureUnitOptions = Enumerable.Empty<string>();
    private IEnumerable<string> _volumeUnitOptions = Enumerable.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        InitializeDateTimeFormatOptions();
        PageTitleService.Title = "Settings";
        UserDTO storedUser = null;

        try
        {
            var userJsonString = await LocalStorage.GetItemAsStringAsync("VHS_USER");

            if (!string.IsNullOrWhiteSpace(userJsonString))
            {
                try
                {
                    storedUser = JsonSerializer.Deserialize<UserDTO>(userJsonString);
                }
                catch (JsonException)
                {
                    var cleanJson = JsonSerializer.Deserialize<string>(userJsonString);
                    if (cleanJson != null)
                    {
                        storedUser = JsonSerializer.Deserialize<UserDTO>(cleanJson);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error reading user data: {ex.Message}", Severity.Error);
            await LocalStorage.RemoveItemAsync("VHS_USER");
        }

        if (storedUser != null)
        {
            var result = await UserSettingClientService.GetUserSettingsByUserIdAsync(storedUser.Id);
            if (result != null)
            {
                _viewModel = result;
                InitializeMeasurementUnitOptions(_viewModel.PreferredMeasurementSystem);
            }
        }
        else
        {
            if (!string.IsNullOrWhiteSpace(await LocalStorage.GetItemAsStringAsync("VHS_USER")))
            {
                Snackbar.Add("Could not parse user data. Please try again.", Severity.Error);
            }
            else
            {
                Snackbar.Add("User not found.", Severity.Warning);
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var existingSettings = await LocalStorage.GetItemAsync<UserSettingDTO>("VHS_USER_SETTINGS");
            var originalLanguage = existingSettings?.PreferredLanguage ?? "en-US";

            var updatedViewModel = await UserSettingClientService.UpdateUserSettingsAsync(_viewModel);
            if (updatedViewModel != null)
            {
                _viewModel = updatedViewModel;

                var userToStore = new UserDTO { Id = _viewModel.UserId, FirstName = _viewModel.FirstName, LastName = _viewModel.LastName, Email = _viewModel.Email };
                await LocalStorage.SetItemAsync("VHS_USER", userToStore);
                await LocalStorage.SetItemAsync("VHS_USER_SETTINGS", _viewModel);

                Snackbar.Add("Settings saved successfully.", Severity.Success);

                if (originalLanguage != _viewModel.PreferredLanguage)
                {
                    await Task.Delay(1000);
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
    }

    private void OnMeasurementSystemChanged(string newSystem)
    {
        _viewModel.PreferredMeasurementSystem = newSystem;
        InitializeMeasurementUnitOptions(newSystem, true);
        StateHasChanged();
    }

    private void InitializeDateTimeFormatOptions()
    {
        var now = DateTime.Now;
        _dateTimeFormatMapping = Enum.GetValues(typeof(DateTimeFormatEnum))
            .Cast<DateTimeFormatEnum>()
            .ToDictionary(
                t => t.GetType()
                      .GetField(t.ToString())?
                      .GetCustomAttributes(typeof(DescriptionAttribute), false)
                      .SingleOrDefault() is not DescriptionAttribute attr ? t.ToString() : attr.Description,
                t =>
                {
                    var formatString = t.GetType()
                                        .GetField(t.ToString())?
                                        .GetCustomAttributes(typeof(DescriptionAttribute), false)
                                        .SingleOrDefault() is not DescriptionAttribute attr ? t.ToString() : attr.Description;
                    return now.ToString(formatString);
                });
    }

    private void InitializeMeasurementUnitOptions(string system, bool reset = false)
    {
        if (system == MeasurementSystemEnum.Metric.ToString())
        {
            _weightUnitOptions = Enum.GetNames(typeof(MetricUnits.WeightUnitEnum));
            _lengthUnitOptions = Enum.GetNames(typeof(MetricUnits.LengthUnitEnum));
            _temperatureUnitOptions = Enum.GetNames(typeof(MetricUnits.TemperatureUnitEnum));
            _volumeUnitOptions = Enum.GetNames(typeof(MetricUnits.VolumeUnitEnum));
            if (reset)
            {
                _viewModel.PreferredWeightUnit = MetricUnits.WeightUnitEnum.Kilogram.ToString();
                _viewModel.PreferredLengthUnit = MetricUnits.LengthUnitEnum.Meter.ToString();
                _viewModel.PreferredTemperatureUnit = MetricUnits.TemperatureUnitEnum.Celsius.ToString();
                _viewModel.PreferredVolumeUnit = MetricUnits.VolumeUnitEnum.Liter.ToString();
            }
        }
        else if (system == MeasurementSystemEnum.Imperial.ToString())
        {
            _weightUnitOptions = Enum.GetNames(typeof(ImperialUnits.WeightUnitEnum));
            _lengthUnitOptions = Enum.GetNames(typeof(ImperialUnits.LengthUnitEnum));
            _temperatureUnitOptions = Enum.GetNames(typeof(ImperialUnits.TemperatureUnitEnum));
            _volumeUnitOptions = Enum.GetNames(typeof(ImperialUnits.VolumeUnitEnum));
            if (reset)
            {
                _viewModel.PreferredWeightUnit = ImperialUnits.WeightUnitEnum.Pound.ToString();
                _viewModel.PreferredLengthUnit = ImperialUnits.LengthUnitEnum.Foot.ToString();
                _viewModel.PreferredTemperatureUnit = ImperialUnits.TemperatureUnitEnum.Fahrenheit.ToString();
                _viewModel.PreferredVolumeUnit = ImperialUnits.VolumeUnitEnum.Gallon.ToString();
            }
        }
    }
}

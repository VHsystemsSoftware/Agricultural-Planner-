@page "/user/settings"
@attribute [Authorize]

@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json
@using VHS.Services.Auth.DTO
@using VHS.Client.Services.Auth
@using VHS.Client.Common
@using VHS.Client.Pages.User
@using VHS.Services.Common.Enums.Languages
@using VHS.Services.Common.Enums.Themes
@using VHS.Services.Common.Enums.Measurements
@using MetricUnits = VHS.Services.Common.Enums.Measurements.Metric
@using ImperialUnits = VHS.Services.Common.Enums.Measurements.Imperial

@inject UserSettingClientService UserSettingClientService
@inject LocalStorage LocalStorage
@inject ISnackbar Snackbar
@inject PageTitleService PageTitleService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <EditForm Model="@_viewModel" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <MudCard>
            <MudCardContent>
                <MudGrid Spacing="4">

                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.h6" GutterBottom="true">Profile</MudText>
                        <MudText Typo="Typo.body2" Class="mb-6">Update your personal information.</MudText>

                        <MudTextField @bind-Value="_viewModel.FirstName"
                                        Label="First Name"
                                        For="@(() => _viewModel.FirstName)"
                                        Variant="Variant.Outlined"
                                        Required="true" />

                        <MudTextField @bind-Value="_viewModel.LastName"
                                        Label="Last Name"
                                        For="@(() => _viewModel.LastName)"
                                        Class="mt-3"
                                        Variant="Variant.Outlined"
                                        Required="true" />

                        <MudTextField @bind-Value="_viewModel.Email"
                                        Label="Email"
                                        For="@(() => _viewModel.Email)"
                                        Class="mt-3"
                                        Variant="Variant.Outlined"
                                        Required="true"
                                        InputType="InputType.Email" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.h6" GutterBottom="true">Preferences</MudText>
                        <MudText Typo="Typo.body2" Class="mb-4">Customize your application experience.</MudText>

                        <MudSelect T="string" Label="Language" @bind-Value="_viewModel.PreferredLanguage" Variant="Variant.Outlined" Required="true">
                            @foreach (var item in _languageMapping)
                            {
                                <MudSelectItem Value="@item.Value">@item.Key</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="Theme" @bind-Value="_viewModel.PreferredTheme" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var theme in Enum.GetNames(typeof(ThemeEnum)))
                            {
                                <MudSelectItem Value="@theme">@theme</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="Measurement System" Value="@_viewModel.PreferredMeasurementSystem" Class="mt-3" Variant="Variant.Outlined" Required="true" ValueChanged="OnMeasurementSystemChanged">
                            @foreach (var ms in Enum.GetNames(typeof(MeasurementSystemEnum)))
                            {
                                <MudSelectItem Value="@ms">@ms</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="Weight Unit" @bind-Value="_viewModel.PreferredWeightUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var wu in _weightUnitOptions)
                            {
                                <MudSelectItem Value="@wu">@wu</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="Length Unit" @bind-Value="_viewModel.PreferredLengthUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var lu in _lengthUnitOptions)
                            {
                                <MudSelectItem Value="@lu">@lu</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="Temperature Unit" @bind-Value="_viewModel.PreferredTemperatureUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var tu in _temperatureUnitOptions)
                            {
                                <MudSelectItem Value="@tu">@tu</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="string" Label="Volume Unit" @bind-Value="_viewModel.PreferredVolumeUnit" Class="mt-3" Variant="Variant.Outlined" Required="true">
                            @foreach (var vu in _volumeUnitOptions)
                            {
                                <MudSelectItem Value="@vu">@vu</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
            <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Save Settings</MudButton>
            </MudCardActions>
        </MudCard>
    </EditForm>
</MudContainer>

@code {
    private UserSettingDTO _viewModel = new();
    private Dictionary<string, string> _languageMapping = new() { { "English", "en-US" }, { "Dutch", "nl-NL" } };
    private IEnumerable<string> _weightUnitOptions = Enumerable.Empty<string>();
    private IEnumerable<string> _lengthUnitOptions = Enumerable.Empty<string>();
    private IEnumerable<string> _temperatureUnitOptions = Enumerable.Empty<string>();
    private IEnumerable<string> _volumeUnitOptions = Enumerable.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.Title = "Settings";
        var userJson = await LocalStorage.GetStateAsync("VHS_USER");
        if (!string.IsNullOrWhiteSpace(userJson))
        {
            var storedUser = JsonSerializer.Deserialize<UserDTO>(userJson);
            if (storedUser != null)
            {
                var result = await UserSettingClientService.GetUserSettingsByUserIdAsync(storedUser.Id);
                if (result != null)
                {
                    _viewModel = result;
                    InitializeMeasurementUnitOptions(_viewModel.PreferredMeasurementSystem);
                }
            }
        }
        else
        {
            Snackbar.Add("User not found.", Severity.Warning);
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var updatedViewModel = await UserSettingClientService.UpdateUserSettingsAsync(_viewModel);
            if (updatedViewModel != null)
            {
                _viewModel = updatedViewModel;

                var userToStore = new UserDTO { Id = _viewModel.UserId, FirstName = _viewModel.FirstName, LastName = _viewModel.LastName, Email = _viewModel.Email };
                await LocalStorage.SaveStateAsync("VHS_USER", JsonSerializer.Serialize(userToStore));

                Snackbar.Add("Settings saved successfully.", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
    }

    private void OnMeasurementSystemChanged(string newSystem)
    {
        _viewModel.PreferredMeasurementSystem = newSystem;
        InitializeMeasurementUnitOptions(newSystem, true);
        StateHasChanged();
    }

    private void InitializeMeasurementUnitOptions(string system, bool reset = false)
    {
        if (system == MeasurementSystemEnum.Metric.ToString())
        {
            _weightUnitOptions = Enum.GetNames(typeof(MetricUnits.WeightUnitEnum));
            _lengthUnitOptions = Enum.GetNames(typeof(MetricUnits.LengthUnitEnum));
            _temperatureUnitOptions = Enum.GetNames(typeof(MetricUnits.TemperatureUnitEnum));
            _volumeUnitOptions = Enum.GetNames(typeof(MetricUnits.VolumeUnitEnum));
            if (reset)
            {
                _viewModel.PreferredWeightUnit = MetricUnits.WeightUnitEnum.Kilogram.ToString();
                _viewModel.PreferredLengthUnit = MetricUnits.LengthUnitEnum.Meter.ToString();
                _viewModel.PreferredTemperatureUnit = MetricUnits.TemperatureUnitEnum.Celsius.ToString();
                _viewModel.PreferredVolumeUnit = MetricUnits.VolumeUnitEnum.Liter.ToString();
            }
        }
        else if (system == MeasurementSystemEnum.Imperial.ToString())
        {
            _weightUnitOptions = Enum.GetNames(typeof(ImperialUnits.WeightUnitEnum));
            _lengthUnitOptions = Enum.GetNames(typeof(ImperialUnits.LengthUnitEnum));
            _temperatureUnitOptions = Enum.GetNames(typeof(ImperialUnits.TemperatureUnitEnum));
            _volumeUnitOptions = Enum.GetNames(typeof(ImperialUnits.VolumeUnitEnum));
            if (reset)
            {
                _viewModel.PreferredWeightUnit = ImperialUnits.WeightUnitEnum.Pound.ToString();
                _viewModel.PreferredLengthUnit = ImperialUnits.LengthUnitEnum.Foot.ToString();
                _viewModel.PreferredTemperatureUnit = ImperialUnits.TemperatureUnitEnum.Fahrenheit.ToString();
                _viewModel.PreferredVolumeUnit = ImperialUnits.VolumeUnitEnum.Gallon.ToString();
            }
        }
    }
}

@using VHS.Client.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject PermissionService PermissionService
@inject AuthenticationStateProvider AuthProvider

<CascadingAuthenticationState>
	<Router AppAssembly="@typeof(App).Assembly">
		<Found Context="routeData">
			<AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(AppMainLayout)">
				<NotAuthorized>
					@if (context.User.Identity?.IsAuthenticated != true)
					{
						<RedirectToLogin />
					}
					else
					{
						<p role="alert">You are not authorized to access this resource.</p>
					}
				</NotAuthorized>
			</AuthorizeRouteView>
			<FocusOnNavigate RouteData="@routeData" Selector="h1" />
		</Found>
		<NotFound>
			<PageTitle>Not found</PageTitle>
			<LayoutView Layout="@typeof(AppMainLayout)">
				<p role="alert">Sorry, there's nothing at this address.</p>
			</LayoutView>
		</NotFound>
	</Router>
</CascadingAuthenticationState>

@code {
	[Inject] HubConnection _hubConnection { get; set; }

	protected override async Task OnInitializedAsync() => await StartupTask();

	async Task StartupTask()
	{
		// Load permissions if user is authenticated
		var authState = await AuthProvider.GetAuthenticationStateAsync();
		if (authState?.User?.Identity?.IsAuthenticated == true)
		{
			try
			{
				await PermissionService.CheckPermissions();
			}
			catch
			{
				// Permissions will remain in default state
			}
		}

		_hubConnection.Closed += async (error) =>
		{
			// Handle disconnection logic here, e.g., try to reconnect
			await Task.Delay(5000); // Wait before trying to reconnect
			Console.WriteLine("Connection closed. Attempting to reconnect...");
			await _hubConnection.StartAsync();
		};
		_hubConnection.Reconnecting += (error) =>
		{
			// Handle logic when the connection is trying to reconnect
			Console.WriteLine("Reconnecting to the hub...");
			return Task.CompletedTask;
		};
		_hubConnection.Reconnected += (connectionId) =>
		{
			// Handle logic when the connection is re-established
			Console.WriteLine($"Reconnected to the hub with connection ID: {connectionId}");
			return Task.CompletedTask;
		};
		if (_hubConnection.State == HubConnectionState.Disconnected) await _hubConnection.StartAsync();
	}
}
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using VHS.Client.Services
@using VHS.Client.Services.Auth
@inject NavigationManager Navigation
@inject LocalStorage LocalStorage
@inject IStringLocalizer<Shared> Localizer
@inject AuthenticationStateProvider AuthProvider
@inject PermissionService PermissionService

<AuthorizeView>
    <Authorized Context="authState">
        @if (authState?.User?.Identity?.IsAuthenticated == true)
        {
            var user = authState.User;
            var picture = user.FindFirst("picture")?.Value;
            var name = user.Identity?.Name ?? user.FindFirst("name")?.Value;
            var email = user.FindFirst("email")?.Value;

            <MudAvatar Class="mx-1" Size="Size.Medium">
                @if (!string.IsNullOrWhiteSpace(picture))
                {
                    <MudImage Src="@picture" Alt="@name" />
                }
                else
                {
                    @GetInitials(name)
                }
            </MudAvatar>

            @* <MudText Align="Align.End" Class="mx-1" Color="Color.Inherit">@name</MudText> *@

            <MudMenu Label="@name" EndIcon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Medium" Color="Color.Default" Edge="Edge.End">
                @if (PermissionService.CanViewUsers)
                {
                    <MudMenuItem Icon="@Icons.Material.Filled.SupervisedUserCircle" OnClick="@Users">@Localizer["Users"]</MudMenuItem>
                }
                <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="@UserSettings">@Localizer["Settings"]</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="@LogoutAsync">@Localizer["Logout"]</MudMenuItem>
            </MudMenu>
        }
    </Authorized>
    <NotAuthorized>
      <MudLink Href="/login" Color="Color.Default" Class="mx-1">@Localizer["Login"]</MudLink>
    </NotAuthorized>
</AuthorizeView>

@code {
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        if (authState?.User?.Identity?.IsAuthenticated == true)
        {
            try
            {
                await PermissionService.CheckPermissions();
            }
            catch
            {
                // Permissions will be false by default
            }
        }
    }

    void Users() => Navigation.NavigateTo("/users");
    void UserSettings() => Navigation.NavigateTo("/user/settings");

    private string? GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return null;

        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0)
            return null;
        if (parts.Length == 1)
            return parts[0].Substring(0, 1).ToUpper();

        return (parts[0][0].ToString() + parts[1][0]).ToUpper();
    }

    async Task LogoutAsync()
    {
        await LocalStorage.RemoveStateAsync("VHS_AUTH_TOKEN");
        await LocalStorage.RemoveStateAsync("VHS_USER");

        if (AuthProvider is IHostEnvironmentAuthenticationStateProvider envProvider)
        {
            envProvider.SetAuthenticationState(Task.FromResult(new AuthenticationState(new System.Security.Claims.ClaimsPrincipal())));
        }

        Navigation.NavigateTo("/login", forceLoad: true);
    }
}
